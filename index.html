<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Supabase 实时云便签</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f8fafc; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 500px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; line-height: 1.6; }
        .footer { margin-top: 10px; font-size: 12px; color: #64748b; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <h2>☁️ Supabase 云便签</h2>
    <textarea id="editor" placeholder="正在连接数据库..."></textarea>
    <div class="footer">
        <span id="status">正在同步...</span>
        <span>数据实时存储在 Supabase</span>
    </div>
</div>

<script>
    // ======= 请填入你的配置 =======
    const SUPABASE_URL = 'https://icmqyrwlvrljudbeircz.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kUx7__4qwVyFXcSrc96FZQ_9WXVlJco';
    // =============================

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');

    // 1. 页面加载：从数据库读取 id 为 1 的那条便签
    async function loadNote() {
        let { data, error } = await supabase
            .from('notes')
            .select('content')
            .limit(1)
            .single();

        if (data) {
            editor.value = data.content;
            status.innerText = "✅ 已加载云端最新内容";
        } else {
            status.innerText = "❌ 加载失败，请检查配置";
        }
    }

    // 2. 自动保存逻辑（防抖）
    let saveTimeout;
    editor.addEventListener('input', () => {
        status.innerText = "正在输入...";
        clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(async () => {
            status.innerText = "正在上传云端...";
            
            // 更新数据库中第一条笔记
            const { error } = await supabase
                .from('notes')
                .update({ content: editor.value })
                .neq('id', 0); // 这是一个简单的匹配所有行的技巧

            if (!error) {
                status.innerText = "☁️ 云端保存成功 " + new Date().toLocaleTimeString();
            } else {
                status.innerText = "⚠️ 保存出错";
                console.error(error);
            }
        }, 1000); // 停止输入 1 秒后执行保存
    });

    loadNote();
</script>
</body>
</html>
