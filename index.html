<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 云便签修复版</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f8fafc; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 500px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; line-height: 1.6; }
        .footer { margin-top: 10px; font-size: 12px; color: #64748b; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <h2>☁️ Supabase 云便签</h2>
    <textarea id="editor" placeholder="正在连接数据库..."></textarea>
    <div class="footer">
        <span id="status">正在同步...</span>
        <span>数据实时存储</span>
    </div>
</div>

<script>
    // ======= 请确保填入你找到的长 Key (以 eyJ 开头) =======
    const CONF_URL = 'https://icmqyrwlvrljudbeircz.supabase.co';
    const CONF_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljbXF5cndsdnJsanVkYmVpcmN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDM4NjksImV4cCI6MjA4NDU3OTg2OX0.0LK94cZykdKphd8zzETwMgsBFPM_xCIEGIevNoTdVGU'; 
    // ===================================================

    // 修复变量名冲突：改名为 client
    const client = supabase.createClient(CONF_URL, CONF_KEY);
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');

    async function loadNote() {
        try {
            status.innerText = "正在从云端读取...";
            let { data, error } = await client
                .from('notes')
                .select('content')
                .eq('id', 1) // 假设你的数据 ID 是 1
                .single();

            if (data) {
                editor.value = data.content;
                status.innerText = "✅ 已加载云端最新内容";
            } else if (error) {
                status.innerText = "⚠️ 未找到数据，请先在后台插入一行 ID 为 1 的数据";
                console.error("读取错误:", error);
            }
        } catch (e) {
            status.innerText = "❌ 连接失败";
        }
    }

    let saveTimeout;
    editor.addEventListener('input', () => {
        status.innerText = "正在输入...";
        clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(async () => {
            status.innerText = "正在同步到云端...";
            
            // 使用 upsert，有则更新无则插入
            const { error } = await client
                .from('notes')
                .upsert({ id: 1, content: editor.value });

            if (!error) {
                status.innerText = "☁️ 云端保存成功 " + new Date().toLocaleTimeString();
            } else {
                status.innerText = "❌ 保存出错: " + error.message;
            }
        }, 1000);
    });

    loadNote();
</script>
</body>
</html>
